<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <link rel='stylesheet' href='./css/styles-default-mobile.css'>
    <link rel='stylesheet' media="screen and (min-width: 900px)" href='./css/styles-desktop.css'>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans|Roboto+Slab&display=swap" rel="stylesheet">

</head>
<body class='flex column align-items'>

    <div class='nav-bar'>
        <a class='nav-bar-logo-wrapper' href='/'>
            <!-- <img class='weather-logo' src='/assets/weather-logo.png' /> -->
            <h1>Task Manager</h1>
        </a>
        <div class='nav-bar-link-wrapper'>
            <a class='nav-link flex' href='/profile'>Profile</a>
            <a id='login-nav' class='nav-link flex' href='#'>Login</a>
            <a id='logout-nav' class='nav-link flex' href='#'>Logout</a>
        </div>
    </div>

    <div id='app-wrapper'>
        <h1 id ="no-user" class='hide' style="text-align: center; color: var(--background-color)">NO USER LOGGED IN</h1>
        <div id='profile' class='hide'></div>
        <div id='image-wrapper' class='hide'>
            <div id='profile-image'><img src='https://via.placeholder.com/150'/></div>
            <form id='image-upload-form' action='/'>
                <input id='new-image' type="file" name="pic" accept="image/png, image/jpeg, image/jpg"></input>
                <button id="image-upload-button">Upload</button>
            </form>
            <div id='change-profile'> Change Avatar </div>
        </div>
        <script>
            $(document).ready(function() {
                const get_profile = () => {
                    $.ajax({
                        type: "GET", //GET, POST, PUT
                        url: '/users/me',  //the url to call   
                        contentType: "application/json; charset=utf-8", 
                        beforeSend: function (xhr) {   //Include the bearer token in header
                            // xhr.setRequestHeader("Authorization", 'Bearer '+ login_res.token);
                            xhr.setRequestHeader("Authorization", getAuthCookie());
                        }
                    }).done(function (response) {
                            $('#profile').removeClass('hide');
                            $('#profile').addClass('flex');
                            $('#image-wrapper').removeClass('hide');
                            $('#image-wrapper').addClass('flex');
                            $('#profile').append(response.name);
                            $('profile').append(response.avatar)
                        // let profile_data = 
                    }).fail(function (err)  {
                        console.log('fail');
                        $('#no-user').addClass('flex');
                        $('#no-user').removeClass('hide');
                    });
                }

                get_profile();

                // IMAGE UPLOAD BUTTON START 
                $('#image-upload-button').click(function(event){
                    event.preventDefault();
                    var fileInput = document.getElementById('#new-image');
                    var file = fileInput.files[0];
                    var formData = new FormData();
                    formData.append('file', file);
                    console.log(formData)
                    $.ajax({
                        type: "POST", //GET, POST, PUT
                        url: '/users/me/avatar',  //the url to call   
                        contentType: "multipart/form-data; boundary=--------------------------765201637728800896457929; charset=utf-8", 
                        beforeSend: function (xhr) {   //Include the bearer token in header
                            // xhr.setRequestHeader("Authorization", 'Bearer '+ login_res.token);
                            xhr.setRequestHeader("Authorization", getAuthCookie());
                        },
                        data: formData
                    }).done(function (response) {

                        console.log('posted image, now display it');
                        this.get_profile();
                        // let profile_data = 
                    }).fail(function (err)  {
                        console.log('fail');
                    });
                });
                // IMAGE UPLOAD BUTTON END

            });
        </script>
        
    </div>

</body>
<footer>
    <script type='text/javascript' src="./js/app.js"></script>

</footer>
</html>